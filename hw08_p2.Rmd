---
title: "HW08, pt 2:"
author: "Julia Du"
date: "`r lubridate::today()`"
output: 
  github_document:
    toc: true
---

## Load necessary libraries

```{r, message = FALSE}
library(tidyverse)
library(stringr)
library(rvest)

theme_set(theme_minimal())
```


```{r mangaupdates}
manga_p1 <- read_html("https://www.mangaupdates.com/stats.html")

manga_p1_nodes <- html_nodes(manga_p1, ".text-truncate span , .text-truncate u, #main_content .text.text-center")

manga_vec <- manga_p1_nodes %>%
  html_text() %>%
  purrr::discard(.p = ~stringr::str_detect(.x,"Rank"))
    
wip_manga <- split(manga_vec, ceiling(seq_along(manga_vec)/3)) %>%
  as_tibble()

almost_manga_df <- wip_manga %>%
  mutate(placeholder = c("rank", "title", "genre"), .before = 1) %>% 
  #could stop here
  mutate(row = row_number()) %>%
  filter(!row == "1") %>%
  pivot_longer(c(`1`:`25`), names_to = "rank", values_to = "values") %>%
  pivot_wider(names_from = placeholder, values_from = values) 

almost_manga_top <- almost_manga_df %>%
  slice_head(n = 25)

almost_manga_bottom <- almost_manga_df %>%
  slice_tail(n = 25)

neat_manga <- left_join(almost_manga_top, almost_manga_bottom, by = "rank") %>%
  select(-c(row.x, genre.x, title.y, row.y)) %>%
  rename(title = title.x, genre = genre.y)

neat_manga
```

```{r manga_multiple}
multiple_manga <- function(url, pg){
  manga <- read_html(url)

manga_nodes <- html_nodes(manga, ".text-truncate span , .text-truncate u, #main_content .text.text-center")

manga_vec <- manga_nodes %>%
  html_text() %>%
  purrr::discard(.p = ~stringr::str_detect(.x,"Rank"))
    
wip_manga <- split(manga_vec, ceiling(seq_along(manga_vec)/3)) %>%
  as_tibble()

almost_manga_df <- wip_manga %>%
  mutate(placeholder = c("rank", "title", "genre"), .before = 1) %>% 
  #could stop here
  mutate(row = row_number()) %>%
  filter(!row == "1") %>%
  pivot_longer(c(`1`:`25`), names_to = "rank", values_to = "values") %>%
  pivot_wider(names_from = placeholder, values_from = values) 

almost_manga_top <- almost_manga_df %>%
  slice_head(n = 25)

almost_manga_bottom <- almost_manga_df %>%
  slice_tail(n = 25)

neat_manga <- left_join(almost_manga_top, almost_manga_bottom, by = "rank") %>%
  select(-c(row.x, genre.x, title.y, row.y)) %>%
  rename(title = title.x, genre = genre.y) %>%
  mutate(rank = as.numeric(rank)) %>%
  mutate(rank = rank + 25*(pg-1))

neat_manga
}

multiple_manga("https://www.mangaupdates.com/stats.html?page=2&", 2)

manga_urls <- c("https://www.mangaupdates.com/stats.html?page=1&", "https://www.mangaupdates.com/stats.html?page=2&", "https://www.mangaupdates.com/stats.html?page=3&")
manga_pgs <- c(1, 2, 3)

manga_75 <- map2_dfr(.x = manga_urls, .y = manga_pgs, .f = multiple_manga)
```



```{r viz_manga}
# function to count how many mangas belong to certain genre
genre_count <- function(genre_string){
  manga_75 %>%
    filter(str_detect(genre, genre_string)) %>%
    count() %>%
    mutate(genre = genre_string)
}

genres_of_interest <- c("Action", "Comedy", "Drama", "Fantasy", "Romance")

map_dfr(genres_of_interest, genre_count) %>%
  ggplot(mapping = aes(x = genre, y = n, fill = genre, label = n)) +
  geom_col() +
  labs(title = "Common genres in 75 top-ranked mangas", subtitle = "As of Mar. 2021", x = "Genre", y = "Number of mangas", fill = "", caption = "Source: mangaupdates.com") +
  geom_label() +
  theme(legend.position = "none")



# have to create new functions because unable to map input vectors of diff lengths 
#shoujo 
shoujo_genre_count <- function(genre_string){
  length <- manga_75 %>%
  filter(str_detect(genre, "Shoujo")) %>%
  count() %>%
  pull()
  
  manga_75 %>%
    filter(str_detect(genre, "Shoujo")) %>%
    filter(str_detect(genre, genre_string)) %>%
    count() %>%
    mutate(genre = genre_string, percent = n/length, audience = "shoujo")
  }

shoujo_df <- map_dfr(genres_of_interest, shoujo_genre_count)

shounen_genre_count <- function(genre_string){
  length <- manga_75 %>%
  filter(str_detect(genre, "Shounen")) %>%
  count() %>%
  pull()
  
  manga_75 %>%
    filter(str_detect(genre, "Shounen")) %>%
    filter(str_detect(genre, genre_string)) %>%
    count() %>%
    mutate(genre = genre_string, percent = n/length, audience = "shounen")
  }

shounen_df <- map_dfr(genres_of_interest, shounen_genre_count)

shoujo_df %>%
  bind_rows(shounen_df) %>% 
  ggplot(aes(x = genre, y = percent, fill = audience)) +
  geom_col(position = position_dodge2(width = 0.9, preserve = "single")) +
  labs(title = "Top genres among popular shoujo and shounen manga", subtitle = "As of Mar. 2021", x = "Genre", y = "Percentage of audience-specific manga", fill = "Audience", caption = "Source: mangaupdates.com") +
  scale_y_continuous(labels = scales::percent) +
  theme(legend.position = "bottom")

```


